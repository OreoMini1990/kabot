# ë‹µì¥ ë©”ì‹œì§€ ì›ë¬¸ ë‚´ìš© ì €ì¥ ë¶„ì„

## í˜„ì¬ êµ¬ì¡° ë¶„ì„

### í˜„ì¬ ì»¬ëŸ¼
- `reply_to_message_id`: DB id (FK, ì›ë¬¸ ë©”ì‹œì§€ ì°¸ì¡°)
- `reply_to_kakao_log_id`: kakao_log_id (ì›ë¬¸ ë©”ì‹œì§€ ì°¸ì¡°)
- `original_message_text`: ë©”ì‹œì§€ ìˆ˜ì • ì „ ì›ë³¸ (ìˆ˜ì • ì´ë ¥ìš©, ë‹µì¥ ì›ë¬¸ ì•„ë‹˜)

### í˜„ì¬ ë°©ì‹ì˜ ë¬¸ì œì 
1. **ì›ë¬¸ ë©”ì‹œì§€ ì‚­ì œ ì‹œ í™•ì¸ ë¶ˆê°€**
   - `reply_to_message_id`ë¡œ ì¡°íšŒí•˜ì§€ë§Œ, ì›ë¬¸ ë©”ì‹œì§€ê°€ ì‚­ì œë˜ë©´ ì¡°íšŒ ì‹¤íŒ¨
   - `reply_to_kakao_log_id`ë¡œë„ ì¡°íšŒí•˜ì§€ë§Œ, ë ˆì´ìŠ¤ ì¡°ê±´ìœ¼ë¡œ ì¸í•´ ì¡°íšŒ ì‹¤íŒ¨ ê°€ëŠ¥

2. **ì¡°íšŒ ì‹¤íŒ¨ ì‹œ ì›ë¬¸ ë‚´ìš© í™•ì¸ ë¶ˆê°€**
   - ì›ë¬¸ ë©”ì‹œì§€ê°€ ì•„ì§ DBì— ì €ì¥ë˜ì§€ ì•Šì€ ê²½ìš°
   - ì›ë¬¸ ë©”ì‹œì§€ê°€ ë‹¤ë¥¸ ì±„íŒ…ë°©ì— ìˆëŠ” ê²½ìš° (room_name ë¶ˆì¼ì¹˜)

3. **ì„±ëŠ¥ ë¬¸ì œ**
   - ë‹µì¥ ë©”ì‹œì§€ ì¡°íšŒ ì‹œë§ˆë‹¤ ì›ë¬¸ ë©”ì‹œì§€ë¥¼ ì¡°íšŒí•´ì•¼ í•¨
   - JOIN ì¿¼ë¦¬ í•„ìš”

## ê°œì„  ë°©ì•ˆ

### ë°©ì•ˆ 1: metadataì— ì €ì¥ (í˜„ì¬ êµ¬í˜„)
- **ì¥ì **: ìŠ¤í‚¤ë§ˆ ë³€ê²½ ë¶ˆí•„ìš”, ì¦‰ì‹œ ì ìš© ê°€ëŠ¥
- **ë‹¨ì **: metadata JSONB í•„ë“œì— ì €ì¥ë˜ì–´ ì¿¼ë¦¬ ì„±ëŠ¥ ì €í•˜ ê°€ëŠ¥

### ë°©ì•ˆ 2: ì „ìš© ì»¬ëŸ¼ ì¶”ê°€ (ê¶Œì¥)
- **ì»¬ëŸ¼**: `reply_to_message_text TEXT`
- **ì¥ì **: 
  - ì „ìš© ì»¬ëŸ¼ìœ¼ë¡œ ì¿¼ë¦¬ ì„±ëŠ¥ í–¥ìƒ
  - ì¸ë±ìŠ¤ ìƒì„± ê°€ëŠ¥
  - ëª…í™•í•œ ë°ì´í„° êµ¬ì¡°
- **ë‹¨ì **: ìŠ¤í‚¤ë§ˆ ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”

## í˜„ì¬ êµ¬í˜„ ìƒíƒœ

### âœ… êµ¬í˜„ ì™„ë£Œ
- ë‹µì¥ ë©”ì‹œì§€ ì €ì¥ ì‹œ ì›ë¬¸ ë‚´ìš© ì¡°íšŒ
- `reply_to_message_id` ë˜ëŠ” `reply_to_kakao_log_id`ë¡œ ì›ë¬¸ ì¡°íšŒ
- ì›ë¬¸ ë‚´ìš©ì„ `metadata.reply_to_message_text`ì— ì €ì¥
- ì›ë¬¸ ë°œì‹ ì ì´ë¦„ì„ `metadata.reply_to_sender_name`ì— ì €ì¥

### ğŸ“‹ ìŠ¤í‚¤ë§ˆ ê°œì„  ì œì•ˆ
```sql
-- chat_messages í…Œì´ë¸”ì— ì»¬ëŸ¼ ì¶”ê°€
ALTER TABLE public.chat_messages 
ADD COLUMN IF NOT EXISTS reply_to_message_text TEXT,
ADD COLUMN IF NOT EXISTS reply_to_sender_name VARCHAR(255);
```

## ì‚¬ìš© ì˜ˆì‹œ

### í˜„ì¬ ë°©ì‹ (metadata ì‚¬ìš©)
```javascript
// ë‹µì¥ ë©”ì‹œì§€ ì¡°íšŒ ì‹œ
const message = await db.supabase
    .from('chat_messages')
    .select('*')
    .eq('id', messageId)
    .single();

// ì›ë¬¸ ë‚´ìš© í™•ì¸
const originalText = message.metadata?.reply_to_message_text;
const originalSender = message.metadata?.reply_to_sender_name;
```

### ê°œì„ ëœ ë°©ì‹ (ì „ìš© ì»¬ëŸ¼ ì‚¬ìš©)
```javascript
// ë‹µì¥ ë©”ì‹œì§€ ì¡°íšŒ ì‹œ
const message = await db.supabase
    .from('chat_messages')
    .select('message_text, reply_to_message_text, reply_to_sender_name')
    .eq('id', messageId)
    .single();

// ì›ë¬¸ ë‚´ìš© í™•ì¸ (ì§ì ‘ ì ‘ê·¼)
const originalText = message.reply_to_message_text;
const originalSender = message.reply_to_sender_name;
```

## ê¶Œì¥ ì‚¬í•­

1. **ë‹¨ê¸°**: í˜„ì¬ êµ¬í˜„ëŒ€ë¡œ `metadata`ì— ì €ì¥ (ìŠ¤í‚¤ë§ˆ ë³€ê²½ ì—†ì´ ì¦‰ì‹œ ì‚¬ìš© ê°€ëŠ¥)
2. **ì¤‘ê¸°**: ìŠ¤í‚¤ë§ˆ ë§ˆì´ê·¸ë ˆì´ì…˜ìœ¼ë¡œ ì „ìš© ì»¬ëŸ¼ ì¶”ê°€ (ì„±ëŠ¥ ë° ëª…í™•ì„± í–¥ìƒ)

## í…ŒìŠ¤íŠ¸ í•„ìš” í•­ëª©

1. ë‹µì¥ ë©”ì‹œì§€ ì €ì¥ ì‹œ ì›ë¬¸ ë‚´ìš©ì´ metadataì— ì €ì¥ë˜ëŠ”ì§€ í™•ì¸
2. ì›ë¬¸ ë©”ì‹œì§€ê°€ ì‚­ì œëœ ê²½ìš°ì—ë„ ì›ë¬¸ ë‚´ìš© í™•ì¸ ê°€ëŠ¥í•œì§€ í™•ì¸
3. ì›ë¬¸ ë©”ì‹œì§€ ì¡°íšŒ ì‹¤íŒ¨ ì‹œì—ë„ ë‹µì¥ ë©”ì‹œì§€ ì €ì¥ì´ ì •ìƒì ìœ¼ë¡œ ë˜ëŠ”ì§€ í™•ì¸

