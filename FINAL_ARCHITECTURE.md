# KakaoBot 최종 아키텍처

## 시스템 구조

```
┌─────────────────┐
│  카카오톡 DB     │
│  (KakaoTalk.db) │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  클라이언트      │
│  kakao_poller.py │  ← 메시지 수신만 담당
└────────┬────────┘
         │ WebSocket
         │ (type: "message")
         ▼
┌─────────────────┐
│  서버            │
│  server.js       │  ← 메시지 처리 및 응답 생성
│  labbot-node.js  │
└────────┬────────┘
         │ WebSocket
         │ (type: "send")
         ▼
┌─────────────────┐
│  Bridge APK     │  ← 메시지 전송만 담당
│  (Android)       │
└────────┬────────┘
         │ RemoteInput
         ▼
┌─────────────────┐
│  카카오톡        │
│  (앱)            │
└─────────────────┘
```

## 역할 분리

### 1. 클라이언트 (kakao_poller.py)
**역할**: 메시지 수신만 담당
- 카카오톡 DB 폴링
- 메시지 복호화
- 서버로 메시지 전송 (WebSocket)
- **제거됨**: 카카오톡 메시지 전송 로직

### 2. 서버 (server.js + labbot-node.js)
**역할**: 메시지 처리 및 응답 생성
- 클라이언트로부터 메시지 수신
- 메시지 처리 및 응답 생성
- Bridge APK로 응답 전송 (type: "send")
- 기존 클라이언트로도 응답 전송 (type: "reply", 호환성)

### 3. Bridge APK (Android)
**역할**: 메시지 전송만 담당
- 서버로부터 응답 수신 (type: "send")
- 큐에 적재 (Room DB)
- 카카오톡 알림 감지 및 자동 전송
- ACK 응답 전송

## 메시지 플로우

### 수신 플로우
1. 클라이언트가 카카오톡 DB 폴링
2. 클라이언트가 서버로 메시지 전송
3. 서버가 메시지 처리 및 응답 생성
4. 서버가 Bridge APK로 응답 전송
5. Bridge APK가 카카오톡으로 메시지 전송

### 전송 플로우 (제거됨)
~~1. 클라이언트가 서버 응답 수신~~
~~2. 클라이언트가 Iris API로 카카오톡 전송~~

→ **이제 Bridge APK가 전송을 담당합니다**

## 변경 사항

### 제거된 기능
- ✅ 클라이언트의 Iris HTTP API 연동
- ✅ 클라이언트의 `send_to_kakaotalk()` 함수
- ✅ 클라이언트의 서버 응답 처리 및 전송 로직
- ✅ `IRIS_URL`, `IRIS_ENABLED` 설정

### 유지된 기능
- ✅ 클라이언트의 메시지 수신 및 서버 전송
- ✅ 서버의 메시지 처리 및 응답 생성
- ✅ Bridge APK의 메시지 전송

## 장점

1. **역할 분리**: 각 컴포넌트가 명확한 역할을 가짐
2. **안정성**: Bridge APK가 전용으로 전송을 담당하여 더 안정적
3. **유지보수**: 코드가 단순해지고 유지보수가 쉬워짐
4. **확장성**: Bridge APK를 통해 다양한 전송 방식 지원 가능





