# êµ¬í˜„ ì™„ë£Œ ìš”ì•½

## 1. DB í•„ë“œ ì±„ìš°ê¸° âœ…

### êµ¬í˜„ ë‚´ìš©
- `reply_to_message_id`: ë‹µì¥ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ ì›ë³¸ ë©”ì‹œì§€ ID ì¶”ì¶œ
- `thread_id`: ìŠ¤ë ˆë“œ ë©”ì‹œì§€ ID ì¶”ì¶œ
- `metadata`: JSONB í•„ë“œì— chat_id ë° ì›ë³¸ JSON ì •ë³´ ì €ì¥

### ì½”ë“œ ìœ„ì¹˜
- `server/server.js`: ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
- `server/db/chatLogger.js`: `saveChatMessage()` í•¨ìˆ˜ì— íŒŒë¼ë¯¸í„° ì¶”ê°€

### ì¶”ì¶œ í•„ë“œ
```javascript
const replyToMessageId = json?.reply_to_message_id || json?.reply_to || json?.parent_message_id || null;
const threadId = json?.thread_id || json?.thread_message_id || null;
const chatId = json?.chat_id || null;
```

## 2. ë‹‰ë„¤ì„ ë³€ê²½ ê°ì§€ âœ…

### êµ¬í˜„ ë‚´ìš©
- Python ì˜ˆì‹œ ì½”ë“œë¥¼ ì°¸ê³ í•˜ì—¬ Node.jsë¡œ êµ¬í˜„
- `user_name_history` í…Œì´ë¸”ì— ë³€ê²½ ì´ë ¥ ìë™ ì €ì¥
- ë³€ê²½ ê°ì§€ ì‹œ ì•Œë¦¼ ë©”ì‹œì§€ ìƒì„±

### ë™ì‘ ë°©ì‹
1. `getOrCreateUser()`ì—ì„œ ì‚¬ìš©ì ì¡°íšŒ ì‹œ ì´ë¦„ ë³€ê²½ ê°ì§€
2. ì´ë¦„ì´ ë³€ê²½ë˜ë©´ `user_name_history` í…Œì´ë¸”ì— ê¸°ë¡
3. `checkNicknameChange()`ì—ì„œ ë³€ê²½ ì´ë ¥ ì¡°íšŒ ë° ì•Œë¦¼ ìƒì„±
4. ì•Œë¦¼ ë©”ì‹œì§€ë¥¼ `replies` ë°°ì—´ì— ì¶”ê°€

### ì•Œë¦¼ í˜•ì‹
```
ğŸš¨ ë‹‰ë„¤ì„ ë³€ê²½ ê°ì§€!

[ë‹‰ë„¤ì„ ë³€ê²½ ì´ë ¥]
	- 2024-01-01 : ì›ë˜ì´ë¦„ â†’ ìƒˆì´ë¦„1
	- 2024-01-15 : ìƒˆì´ë¦„1 â†’ ìƒˆì´ë¦„2
```

### í¬ì¸íŠ¸/ë°˜ì‘ ì‹œìŠ¤í…œ ì—°ë™
- `internal_user_id`ë¥¼ ì‚¬ìš©í•˜ì—¬ ë‹‰ë„¤ì„ ë³€ê²½ê³¼ ë¬´ê´€í•˜ê²Œ ì‚¬ìš©ì ì‹ë³„
- í¬ì¸íŠ¸ë‚˜ ë°˜ì‘ì€ `user_id`ë¡œ ì—°ê²°ë˜ë¯€ë¡œ ë‹‰ë„¤ì„ ë³€ê²½ê³¼ ë¬´ê´€í•˜ê²Œ ìœ ì§€ë¨

## 3. ì‹ ê³  ê¸°ëŠ¥ âœ…

### ê¸°ìˆ ì  íŒë‹¨: **ê°€ëŠ¥í•¨** âœ…

#### êµ¬í˜„ ê°€ëŠ¥í•œ ì´ìœ 
1. **ë‹µì¥ ë²„íŠ¼ ê¸°ëŠ¥**: ì¹´ì¹´ì˜¤í†¡ì—ì„œ ë‹µì¥ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ `reply_to_message_id`ê°€ JSONì— í¬í•¨ë¨
2. **ë©”ì‹œì§€ ë‚´ìš© ê°ì§€**: ë©”ì‹œì§€ì— "ì‹ ê³ " í‚¤ì›Œë“œê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸ ê°€ëŠ¥
3. **ë´‡ ë©˜ì…˜**: ë©”ì‹œì§€ì— ë´‡ì„ ë©˜ì…˜(@ë´‡ì´ë¦„)í•˜ë©´ ê°ì§€ ê°€ëŠ¥

#### êµ¬í˜„ ë°©ì‹
1. `handleMessage()` í•¨ìˆ˜ì—ì„œ `replyToMessageId`ê°€ ìˆê³  ë©”ì‹œì§€ê°€ "ì‹ ê³ "ë¡œ ì‹œì‘í•˜ëŠ”ì§€ í™•ì¸
2. ì¡°ê±´ì´ ë§ìœ¼ë©´ `saveReport()` í•¨ìˆ˜ í˜¸ì¶œ
3. ì‹ ê³  ì •ë³´ë¥¼ `reports` í…Œì´ë¸”ì— ì €ì¥
4. ì‹ ê³  ì ‘ìˆ˜ í™•ì¸ ë©”ì‹œì§€ ë°˜í™˜

### ì‚¬ìš© ë°©ë²•
1. íƒ€ ìœ ì €ì˜ ì±„íŒ…ê¸€ì— **ë‹µì¥ ë²„íŠ¼** í´ë¦­
2. ë´‡ì„ **ë©˜ì…˜**í•˜ê³  **"ì‹ ê³ "** ë˜ëŠ” **"ì‹ ê³  [ì‚¬ìœ ]"** ì…ë ¥
3. ë´‡ì´ ì‹ ê³ ë¥¼ ì ‘ìˆ˜í•˜ê³  í™•ì¸ ë©”ì‹œì§€ ì „ì†¡

### DB ìŠ¤í‚¤ë§ˆ
- `server/db/reports_schema.sql`: ì‹ ê³  í…Œì´ë¸” ìƒì„±
- í•„ë“œ: `reported_message_id`, `reporter_user_id`, `report_reason`, `status` ë“±

### ì½”ë“œ ìœ„ì¹˜
- `server/labbot-node.js`: `handleMessage()` í•¨ìˆ˜ ì‹œì‘ ë¶€ë¶„ì— ì‹ ê³  ì²˜ë¦¬ ë¡œì§ ì¶”ê°€
- `server/db/chatLogger.js`: `saveReport()` í•¨ìˆ˜ êµ¬í˜„

## ìˆ˜ì •ëœ íŒŒì¼ ëª©ë¡

1. **server/server.js**
   - ë©”ì‹œì§€ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ (reply_to_message_id, thread_id)
   - ë‹‰ë„¤ì„ ë³€ê²½ ê°ì§€ í˜¸ì¶œ
   - handleMessageì— replyToMessageId ì „ë‹¬

2. **server/db/chatLogger.js**
   - `saveChatMessage()`: replyToMessageId, threadId íŒŒë¼ë¯¸í„° ì¶”ê°€
   - `checkNicknameChange()`: ë‹‰ë„¤ì„ ë³€ê²½ ê°ì§€ ë° ì•Œë¦¼ ìƒì„±
   - `saveReport()`: ì‹ ê³  ì €ì¥ í•¨ìˆ˜

3. **server/labbot-node.js**
   - `handleMessage()`: replyToMessageId íŒŒë¼ë¯¸í„° ì¶”ê°€
   - ì‹ ê³  ì²˜ë¦¬ ë¡œì§ ì¶”ê°€ (ë‹µì¥ + "ì‹ ê³ " í‚¤ì›Œë“œ)

4. **server/db/reports_schema.sql** (ì‹ ê·œ)
   - ì‹ ê³  í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ

## Supabase ì„¤ì •

1. `server/db/chat_logs_schema.sql` ì‹¤í–‰ (ì´ë¯¸ ì™„ë£Œ)
2. `server/db/reports_schema.sql` ì‹¤í–‰ (ì‹ ê·œ)

## í…ŒìŠ¤íŠ¸ ë°©ë²•

### ë‹‰ë„¤ì„ ë³€ê²½ ê°ì§€
1. ì‚¬ìš©ìê°€ ë‹‰ë„¤ì„ ë³€ê²½
2. ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡
3. ë´‡ì´ ë‹‰ë„¤ì„ ë³€ê²½ ê°ì§€ ë° ì•Œë¦¼ ì „ì†¡

### ì‹ ê³  ê¸°ëŠ¥
1. íƒ€ ìœ ì € ë©”ì‹œì§€ì— ë‹µì¥ ë²„íŠ¼ í´ë¦­
2. ë´‡ ë©˜ì…˜ + "ì‹ ê³ " ì…ë ¥
3. ë´‡ì´ ì‹ ê³  ì ‘ìˆ˜ í™•ì¸ ë©”ì‹œì§€ ì „ì†¡
4. `reports` í…Œì´ë¸”ì—ì„œ ì‹ ê³  ë‚´ì—­ í™•ì¸

