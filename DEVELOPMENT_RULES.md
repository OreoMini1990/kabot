# 개발 규칙 및 가이드라인

이 문서는 프로젝트 개발 중 발견된 규칙과 가이드라인을 기록합니다.

## 중요 원칙

### 1. 문제 우회 금지
**규칙**: 문제를 우회하지 말고 근본 원인을 해결해야 합니다.

**예시**:
- ❌ 잘못된 예: 복호화 실패 시 암호화된 메시지 처리 (우회)
- ✅ 올바른 예: 복호화 실패 원인을 규명하고 해결

**적용**:
- 복호화 실패는 용납할 수 없는 일이므로 반드시 원인을 규명하고 해결해야 합니다.
- 임시 방편이나 우회 방법을 사용하지 말고 근본적인 해결책을 찾아야 합니다.

### 3. 핵심 코드 수정 시 롤백 준비
**규칙**: 개발 핵심이 되는 중요한 코드를 수정할 때는 주석 처리하거나 롤백 가능하도록 해야 합니다.

**적용**:
- 복호화 로직 같은 핵심 기능을 수정할 때는:
  1. 기존 코드를 주석 처리하여 보존
  2. 새 코드를 추가하되 기존 코드는 유지
  3. 또는 Git 브랜치를 만들어서 안전하게 테스트
- 기능을 다 없애지 말고 똑똑하게 작업해야 합니다.
- 커밋은 롤백 가능한 상태로 유지해야 합니다.

### 2. 기술적 제약사항 기록
**규칙**: 개발 중 발견된 기술적 제약사항이나 규칙을 기록하여 반복되지 않도록 합니다.

**예시**:
- PowerShell에서는 `&&` 연산자를 사용할 수 없습니다.
  - 대신: `;` 또는 별도 명령어로 분리
  - 또는: `if ($?) { ... }` 패턴 사용

## 기술적 제약사항

### PowerShell
- **`&&` 연산자 사용 불가**: PowerShell에서는 `&&`를 사용할 수 없습니다.
  - **해결 방법**:
    ```powershell
    # 잘못된 예
    git add -A && git commit -m "message"
    
    # 올바른 예
    git add -A
    if ($?) { git commit -m "message" }
    
    # 또는
    git add -A; git commit -m "message"
    ```

### 복호화 ⚠️ 핵심 보호 규칙
- **⚠️ 복호화 로직은 절대 수정 금지**: 복호화 로직은 프로젝트의 가장 중요한 핵심 기능입니다.
  - **백업 파일**: `client/DECRYPTION_LOGIC_BACKUP.py`에 복호화 로직이 백업되어 있습니다.
  - **수정 전 필수 사항**:
    1. 반드시 Git 커밋 생성 (현재 상태 보존)
    2. 백업 파일(`DECRYPTION_LOGIC_BACKUP.py`) 참고하여 원래 상태 확인
    3. 수정 후 반드시 로컬에서 복호화 테스트 실행
    4. 복호화 성공률 확인 및 실패 케이스 분석
    5. 수정 사항을 문서화
  - **복호화 로직 구조 (절대 변경 금지)**:
    - `decrypt_message()` 함수: 메시지 복호화 메인 함수
    - `decrypt_kakaotalk_message()` 함수: 카카오톡 메시지 복호화
    - `send_to_server()` 함수 내 복호화 처리: `MY_USER_ID` 사용
    - `poll_messages()` 함수: 복호화하지 않고 원본 메시지 전송
  - **복호화 실패는 용납 불가**: 모든 메시지는 반드시 복호화되어야 합니다.
    - 복호화 실패 시 원인 규명 필수:
      1. 클라이언트에서 복호화 시도 여부 확인
      2. 서버에서 복호화 시도 여부 확인
      3. userId 및 encType 정확성 확인
      4. 복호화 키 유효성 확인
    - 복호화 실패한 메시지를 처리하는 것은 우회 방법이므로 금지됩니다.
  - **복호화에 사용하는 user_id (절대 변경 금지)**:
    - 메시지 복호화: `MY_USER_ID` (자신의 user_id) 사용
    - 채팅방 이름 복호화: `MY_USER_ID` (자신의 user_id) 사용
    - ❌ 발신자 user_id 사용 금지 (정상 작동 코드 기준)
  - **복호화 모듈 우선순위 (절대 변경 금지)**:
    1. `KakaoDecrypt.decrypt()` (kakaodecrypt 모듈)
    2. 자체 구현 복호화 로직
    3. base64 디코딩

## 코드 품질 규칙

### 1. 에러 처리
- 모든 에러는 로그에 기록되어야 합니다.
- 에러 발생 시 원인을 추적할 수 있는 충분한 정보를 로그에 포함해야 합니다.

### 2. 로깅
- 중요한 작업은 반드시 로그로 기록해야 합니다.
- 디버깅에 필요한 정보는 충분히 포함해야 합니다.

### 3. 테스트
- 수정 사항은 반드시 테스트해야 합니다.
- 테스트 실패 시 원인을 규명하고 해결해야 합니다.

## 업데이트 기록

- 2025-12-16: PowerShell `&&` 연산자 제약사항 추가
- 2025-12-16: 복호화 실패 처리 원칙 추가
- 2025-12-16: 핵심 코드 수정 시 롤백 가능하도록 주석 처리 규칙 추가
- 2025-12-16: **복호화 로직 절대 수정 금지 규칙 추가 및 백업 파일 생성**

