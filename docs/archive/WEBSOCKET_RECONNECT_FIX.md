# WebSocket 재연결 로직 개선

## 문제

클라이언트 WebSocket이 한 번 종료되면 재연결을 시도하지 않고 그대로 끝나는 문제가 있었습니다.

## 해결

### 1. 재연결 로직 추가

**변경 사항**:
- `on_close` 콜백에서 재연결 스레드 시작
- 3초 간격으로 최대 10번 재연결 시도
- 연결 성공 시 재연결 카운터 리셋
- 중복 재연결 시도 방지

### 2. 구현 세부사항

**전역 변수 추가**:
```python
ws_reconnect_thread = None  # 재연결 스레드
ws_reconnect_attempts = 0  # 재연결 시도 횟수
MAX_RECONNECT_ATTEMPTS = 10  # 최대 재연결 시도 횟수
RECONNECT_INTERVAL = 3  # 재연결 간격 (초)
```

**재연결 로직**:
- `on_close`에서 재연결 스레드 시작
- 3초 대기 후 재연결 시도
- 최대 10번 시도
- 연결 성공 시 즉시 중단
- 연결 실패 시 다음 시도까지 3초 대기

### 3. 로그 출력

**재연결 시도**:
```
[재연결 시도 1/10] 3초 후 재연결 시도...
[재연결 시도 1/10] 연결 시도 중...
[✓] 재연결 성공 (1번째 시도)
```

**재연결 실패**:
```
[✗] 재연결 실패 (1/10)
[재연결 시도 2/10] 3초 후 재연결 시도...
```

**최대 시도 초과**:
```
[✗] 재연결 실패: 최대 시도 횟수(10) 초과. 재연결을 중단합니다.
```

## 테스트 방법

### 1. 정상 연결 테스트
1. 클라이언트 실행: `python kakao_poller.py`
2. WebSocket 연결 확인: `[✓] WebSocket 연결 성공`

### 2. 재연결 테스트
1. 서버 중지: `Ctrl+C` 또는 서버 프로세스 종료
2. 클라이언트 로그 확인:
   ```
   [WebSocket 연결 종료] code=..., msg=...
   [재연결 시도 1/10] 3초 후 재연결 시도...
   ```
3. 서버 재시작: `node server.js`
4. 클라이언트 로그 확인:
   ```
   [재연결 시도 1/10] 연결 시도 중...
   [✓] 재연결 성공 (1번째 시도)
   ```

### 3. 최대 시도 테스트
1. 서버를 30초 이상 중지 상태로 유지
2. 클라이언트가 10번 시도하는지 확인
3. 최대 시도 초과 메시지 확인

## 예상 동작

### 정상 시나리오
1. WebSocket 연결
2. 서버 중지 → 연결 종료
3. 3초 대기
4. 재연결 시도 1/10
5. 서버 재시작
6. 재연결 성공

### 재연결 실패 시나리오
1. WebSocket 연결
2. 서버 중지 → 연결 종료
3. 3초 간격으로 재연결 시도 (최대 10번)
4. 10번 실패 후 재연결 중단
5. 수동으로 클라이언트 재시작 필요

## 추가 개선 가능 사항

### 자동 재시작
최대 시도 초과 후에도 계속 시도하도록 변경 가능:
```python
# 무한 재연결 (선택사항)
while True:
    time.sleep(RECONNECT_INTERVAL)
    if connect_websocket():
        break
```

### 지수 백오프
재연결 간격을 점진적으로 증가:
```python
interval = RECONNECT_INTERVAL * (2 ** (ws_reconnect_attempts - 1))
```

현재는 고정 간격(3초)을 사용합니다.

