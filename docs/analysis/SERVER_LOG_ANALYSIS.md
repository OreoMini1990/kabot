# ì„œë²„ ë¡œê·¸ ë¶„ì„ (2025-12-20T11:31:29)

## ë¡œê·¸ ê°œìš”

ì´ë¯¸ì§€ ë©”ì‹œì§€ ì²˜ë¦¬ íë¦„ì´ **ì •ìƒì ìœ¼ë¡œ ì‘ë™**í•˜ê³  ìˆìŠµë‹ˆë‹¤. ë‹¤ë§Œ ì§ˆë¬¸ ëŒ€ê¸° ìƒíƒœì™€ ê´€ë ¨ëœ ìºì‹œ ë¯¸ìŠ¤ ë¬¸ì œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.

---

## 1. ì„±ê³µì ì¸ ì²˜ë¦¬ íë¦„

### 1.1 ì´ë¯¸ì§€ ë©”ì‹œì§€ ê°ì§€
```
- msgType: 2 (PhotoChat) âœ…
- has_image: true âœ…
- isImageMessageEarly: true âœ…
```

### 1.2 Attachment ë³µí˜¸í™”
```
- ë³µí˜¸í™” ì„±ê³µ âœ…
- JSON íŒŒì‹± ì„±ê³µ âœ…
- URL ì¶”ì¶œ ì„±ê³µ: https://talk.kakaocdn.net/dna/wuvnG/... âœ…
```

### 1.3 ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
```
- ë‹¤ìš´ë¡œë“œ ì„±ê³µ: 43195 bytes âœ…
- ì„œë²„ URL ìƒì„±: http://192.168.0.15:5002/api/image/kakao_1766230289647_891e9a46.jpg âœ…
```

### 1.4 Bridge APK ì „ì†¡
```
- ì´ë¯¸ì§€ URL í¬í•¨ ë©”ì‹œì§€ ì „ì†¡ ì„±ê³µ âœ…
- roomKey: "ì˜ìš´ëª¨" âœ…
```

---

## 2. ë°œê²¬ëœ ë¬¸ì œ

### 2.1 ì§ˆë¬¸ ëŒ€ê¸° ìƒíƒœ ìºì‹œ ë¯¸ìŠ¤ âš ï¸

**ë¡œê·¸ ìœ„ì¹˜**: ë¼ì¸ 129-134

```
[ì§ˆë¬¸ ëŒ€ê¸°] ì¡°íšŒ ì‹œë„: roomName="ì˜ìš´ëª¨", senderId="429744344"
[ì§ˆë¬¸ ëŒ€ê¸°] ìºì‹œ í‚¤ ìƒì„±: "ì˜ìš´ëª¨|429744344"
[ì§ˆë¬¸ ëŒ€ê¸°] í˜„ì¬ ìºì‹œ í‚¤ ê°œìˆ˜: 1
[ì§ˆë¬¸ ëŒ€ê¸°] ìœ ì‚¬ í‚¤ ìƒ˜í”Œ: ì˜ìš´ëª¨|AN
[ì§ˆë¬¸ ëŒ€ê¸°] âš ï¸ ìºì‹œ ë¯¸ìŠ¤: key="ì˜ìš´ëª¨|429744344"
```

**ë¬¸ì œ ë¶„ì„**:
1. **ìºì‹œ í‚¤ ë¶ˆì¼ì¹˜**: 
   - ì¡°íšŒ ì‹œë„ í‚¤: `"ì˜ìš´ëª¨|429744344"` (senderIdê°€ ìˆ«ì)
   - ìºì‹œì— ì €ì¥ëœ í‚¤: `"ì˜ìš´ëª¨|AN"` (senderIdê°€ "AN")

2. **ê°€ëŠ¥í•œ ì›ì¸**:
   - `!ì§ˆë¬¸` ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•  ë•Œ `senderId`ê°€ "AN"ìœ¼ë¡œ ì €ì¥ë¨
   - í•˜ì§€ë§Œ ì´ë¯¸ì§€ ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ë•Œ `senderId`ê°€ "429744344"ë¡œ ì „ë‹¬ë¨
   - ì´ë¡œ ì¸í•´ ìºì‹œ í‚¤ê°€ ì¼ì¹˜í•˜ì§€ ì•Šì•„ ë¯¸ìŠ¤ ë°œìƒ

3. **ì˜í–¥**:
   - ì´ë¯¸ì§€ê°€ `!ì§ˆë¬¸` ëª…ë ¹ì–´ì™€ ì—°ê²°ë˜ì§€ ì•ŠìŒ
   - ì´ë¯¸ì§€ëŠ” ìºì‹œì— ì €ì¥ë˜ì§€ë§Œ, ì§ˆë¬¸ê³¼ ì—°ê²°ë˜ì§€ ì•Šì•„ Naver Cafeì— ì—…ë¡œë“œë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ

**ì¶”ì • ì›ì¸**:
- `!ì§ˆë¬¸` ëª…ë ¹ì–´ ì²˜ë¦¬ ì‹œ `senderId` ì¶”ì¶œ ë°©ì‹ê³¼ ì´ë¯¸ì§€ ë©”ì‹œì§€ ì²˜ë¦¬ ì‹œ `senderId` ì¶”ì¶œ ë°©ì‹ì´ ë‹¤ë¦„
- sender í•„ë“œì—ì„œ IDë¥¼ ì¶”ì¶œí•  ë•Œ ì¼ê´€ì„±ì´ ì—†ìŒ (ì˜ˆ: "AN/429744344" vs "429744344")

---

## 3. ì¶”ê°€ í™•ì¸ ì‚¬í•­

### 3.1 Sender ID ì¶”ì¶œ ì¼ê´€ì„±

**ë¡œê·¸ì—ì„œ í™•ì¸ëœ ê°’**:
- ë¼ì¸ 16-17: `sender="429744344"`, `senderId="429744344"`
- ë¼ì¸ 62: DB ì €ì¥ ì‹œ `sender_name="429744344"`, `sender_id="429744344"`
- ë¼ì¸ 128: ì§ˆë¬¸ ëŒ€ê¸° ìƒíƒœ í™•ì¸ ì‹œ `senderId="429744344"`

**ë¬¸ì œ**: 
- ìºì‹œì—ëŠ” `"ì˜ìš´ëª¨|AN"`ì´ ì €ì¥ë˜ì–´ ìˆìŒ
- ì´ëŠ” `!ì§ˆë¬¸` ëª…ë ¹ì–´ ì‹¤í–‰ ì‹œ `senderId`ê°€ "AN"ìœ¼ë¡œ ì¶”ì¶œë˜ì—ˆë‹¤ëŠ” ì˜ë¯¸

**í™•ì¸ì´ í•„ìš”í•œ ë¶€ë¶„**:
- `!ì§ˆë¬¸` ëª…ë ¹ì–´ ì²˜ë¦¬ ì‹œ `senderId` ì¶”ì¶œ ë¡œì§ í™•ì¸
- `extractSenderId()` í•¨ìˆ˜ì˜ ë™ì‘ ë°©ì‹ í™•ì¸
- sender í•„ë“œ íŒŒì‹± ë¡œì§ í™•ì¸

### 3.2 ì´ë¯¸ì§€ ìºì‹œ ì €ì¥

**ë¡œê·¸** (ë¼ì¸ 135):
```
[ì´ë¯¸ì§€ ìºì‹œ] ì €ì¥: key="ì˜ìš´ëª¨|429744344", roomName="ì˜ìš´ëª¨", senderId="429744344", url=http://...
```

**ë¶„ì„**:
- ì´ë¯¸ì§€ëŠ” `"ì˜ìš´ëª¨|429744344"` í‚¤ë¡œ ì €ì¥ë¨
- í•˜ì§€ë§Œ ì§ˆë¬¸ ëŒ€ê¸° ìƒíƒœëŠ” `"ì˜ìš´ëª¨|AN"` í‚¤ë¡œ ì €ì¥ë˜ì–´ ìˆìŒ
- ë‘ ìºì‹œ í‚¤ê°€ ì¼ì¹˜í•˜ì§€ ì•Šì•„ ì—°ê²°ë˜ì§€ ì•ŠìŒ

---

## 4. ê¶Œì¥ í•´ê²° ë°©ì•ˆ

### 4.1 Sender ID ì¶”ì¶œ í†µì¼

**ë¬¸ì œ**: sender í•„ë“œì—ì„œ IDë¥¼ ì¶”ì¶œí•  ë•Œ ì¼ê´€ì„±ì´ ì—†ìŒ

**í•´ê²°ì±…**:
1. **í‘œì¤€í™”ëœ ID ì¶”ì¶œ í•¨ìˆ˜ ì‚¬ìš©**
   - ëª¨ë“  ê³³ì—ì„œ `extractSenderId()` í•¨ìˆ˜ ì‚¬ìš©
   - sender í•„ë“œ íŒŒì‹± ë¡œì§ í†µì¼ (ì˜ˆ: "ì´ë¦„/ID" í˜•ì‹ ì²˜ë¦¬)

2. **ìºì‹œ í‚¤ ìƒì„± ì‹œ ì •ê·œí™”**
   - senderIdë¥¼ ìˆ«ìë¡œ ë³€í™˜í•˜ì—¬ ë¹„êµ
   - ë˜ëŠ” í•­ìƒ "ì´ë¦„/ID" í˜•ì‹ìœ¼ë¡œ ì €ì¥

3. **ìºì‹œ ì¡°íšŒ ì‹œ ìœ ì—°ì„±**
   - ì •í™•í•œ í‚¤ë¡œ ì¡°íšŒ ì‹¤íŒ¨ ì‹œ, senderNameìœ¼ë¡œ ì¬ì¡°íšŒ
   - ë˜ëŠ” roomName + senderName ì¡°í•©ìœ¼ë¡œë„ ì¡°íšŒ ì‹œë„

### 4.2 ë””ë²„ê¹… ê°•í™”

**ì¶”ê°€ ë¡œê·¸ í•„ìš”**:
```javascript
// !ì§ˆë¬¸ ëª…ë ¹ì–´ ì²˜ë¦¬ ì‹œ
console.log('[!ì§ˆë¬¸] senderId ì¶”ì¶œ:', {
  originalSender: sender,
  extractedId: senderId,
  extractedName: senderName,
  cacheKey: cacheKey
});

// ì´ë¯¸ì§€ ë©”ì‹œì§€ ì²˜ë¦¬ ì‹œ
console.log('[ì´ë¯¸ì§€] senderId í™•ì¸:', {
  originalSender: sender,
  extractedId: senderId,
  cacheKey: cacheKey,
  pendingQuestionKey: pendingQuestionKey
});
```

### 4.3 ìºì‹œ í‚¤ ì •ê·œí™” í•¨ìˆ˜

```javascript
function normalizeSenderId(sender) {
  // "ì´ë¦„/ID" í˜•ì‹ì—ì„œ ID ì¶”ì¶œ
  if (typeof sender === 'string' && sender.includes('/')) {
    const parts = sender.split('/');
    return parts[parts.length - 1].trim(); // ë§ˆì§€ë§‰ ë¶€ë¶„ì´ ID
  }
  // ìˆ«ìë§Œ ìˆëŠ” ê²½ìš° ê·¸ëŒ€ë¡œ ë°˜í™˜
  if (/^\d+$/.test(String(sender))) {
    return String(sender);
  }
  return sender;
}

function createPendingQuestionKey(roomName, senderId) {
  const normalizedId = normalizeSenderId(senderId);
  return `${roomName}|${normalizedId}`;
}
```

---

## 5. ë¡œê·¸ ìƒì„¸ ë¶„ì„

### 5.1 ì´ë¯¸ì§€ ì²˜ë¦¬ ì„±ê³µ íë¦„

1. **ë©”ì‹œì§€ ìˆ˜ì‹ ** (ë¼ì¸ 32-39)
   - room: "ì˜ìš´ëª¨"
   - sender: "429744344"
   - message: "ì‚¬ì§„"
   - msgType: 2

2. **ì´ë¯¸ì§€ ê°ì§€** (ë¼ì¸ 47-55)
   - isImageMessageEarly: true
   - í•˜ì§€ë§Œ URL ì¶”ì¶œ ì‹¤íŒ¨ (ì´ˆê¸° ë‹¨ê³„)

3. **Attachment ë³µí˜¸í™”** (ë¼ì¸ 82-93)
   - ë³µí˜¸í™” ì„±ê³µ
   - JSON íŒŒì‹± ì„±ê³µ
   - thumbnailUrl ì¶”ì¶œ ì„±ê³µ

4. **ì´ë¯¸ì§€ ì²˜ë¦¬** (ë¼ì¸ 95-103)
   - URL ì¶”ì¶œ ì„±ê³µ
   - ë‹¤ìš´ë¡œë“œ ì„±ê³µ
   - ì„œë²„ URL ìƒì„± ì„±ê³µ

5. **Bridge APK ì „ì†¡** (ë¼ì¸ 166-192)
   - ì´ë¯¸ì§€ URL í¬í•¨ ë©”ì‹œì§€ ì „ì†¡ ì„±ê³µ

### 5.2 ì§ˆë¬¸ ëŒ€ê¸° ìƒíƒœ í™•ì¸ ì‹¤íŒ¨

**ë¼ì¸ 128-134**:
```
[ì´ë¯¸ì§€ + ì§ˆë¬¸] ì§ˆë¬¸ ëŒ€ê¸° ìƒíƒœ í™•ì¸ ì‹œì‘: roomName="ì˜ìš´ëª¨", senderId="429744344"
[ì§ˆë¬¸ ëŒ€ê¸°] ì¡°íšŒ ì‹œë„: roomName="ì˜ìš´ëª¨", senderId="429744344"
[ì§ˆë¬¸ ëŒ€ê¸°] ìºì‹œ í‚¤ ìƒì„±: "ì˜ìš´ëª¨|429744344"
[ì§ˆë¬¸ ëŒ€ê¸°] í˜„ì¬ ìºì‹œ í‚¤ ê°œìˆ˜: 1
[ì§ˆë¬¸ ëŒ€ê¸°] ìœ ì‚¬ í‚¤ ìƒ˜í”Œ: ì˜ìš´ëª¨|AN
[ì§ˆë¬¸ ëŒ€ê¸°] âš ï¸ ìºì‹œ ë¯¸ìŠ¤: key="ì˜ìš´ëª¨|429744344"
[ì´ë¯¸ì§€ + ì§ˆë¬¸] âš ï¸ ì§ˆë¬¸ ëŒ€ê¸° ìƒíƒœ ì—†ìŒ: roomName="ì˜ìš´ëª¨", senderId="429744344"
```

**ë¶„ì„**:
- ì§ˆë¬¸ ëŒ€ê¸° ìƒíƒœê°€ ìˆì§€ë§Œ, senderId ë¶ˆì¼ì¹˜ë¡œ ì¡°íšŒ ì‹¤íŒ¨
- ì´ë¯¸ì§€ëŠ” ìºì‹œì— ì €ì¥ë˜ì§€ë§Œ, ì§ˆë¬¸ê³¼ ì—°ê²°ë˜ì§€ ì•ŠìŒ

---

## 6. ê²°ë¡ 

### âœ… ì •ìƒ ì‘ë™
- ì´ë¯¸ì§€ ë©”ì‹œì§€ ê°ì§€ ë° ì²˜ë¦¬
- Attachment ë³µí˜¸í™”
- ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ë° ì„œë²„ ì €ì¥
- Bridge APK ì „ì†¡

### âš ï¸ ê°œì„  í•„ìš”
- **ì§ˆë¬¸ ëŒ€ê¸° ìƒíƒœ ìºì‹œ í‚¤ ë¶ˆì¼ì¹˜**
  - `!ì§ˆë¬¸` ëª…ë ¹ì–´ ì‹¤í–‰ ì‹œ senderId ì¶”ì¶œ ë°©ì‹
  - ì´ë¯¸ì§€ ë©”ì‹œì§€ ì²˜ë¦¬ ì‹œ senderId ì¶”ì¶œ ë°©ì‹
  - ë‘ ë°©ì‹ì´ ì¼ì¹˜í•˜ì§€ ì•Šì•„ ìºì‹œ ë¯¸ìŠ¤ ë°œìƒ

### ğŸ”§ ì¦‰ì‹œ ìˆ˜ì • ê¶Œì¥
1. senderId ì¶”ì¶œ ë¡œì§ í†µì¼
2. ìºì‹œ í‚¤ ìƒì„± ì‹œ ì •ê·œí™” ì ìš©
3. ìºì‹œ ì¡°íšŒ ì‹œ ìœ ì—°ì„± ì¶”ê°€ (fallback ë¡œì§)

---

## 7. ì½”ë“œ ë¶„ì„ ê²°ê³¼

### 7.1 `createCacheKey` í•¨ìˆ˜

```javascript
// server/db/utils/roomKeyNormalizer.js
function createCacheKey(roomName, senderId) {
    const normalizedRoom = normalizeRoomNameForCache(roomName);
    const normalizedSender = String(senderId || '').trim();
    return `${normalizedRoom}|${normalizedSender}`;
}
```

**ë¶„ì„**:
- senderIdë¥¼ ë‹¨ìˆœíˆ `String().trim()`ìœ¼ë¡œ ë³€í™˜ë§Œ í•¨
- "ì´ë¦„/ID" í˜•ì‹ì—ì„œ IDë¥¼ ì¶”ì¶œí•˜ì§€ ì•ŠìŒ
- ë”°ë¼ì„œ sender í•„ë“œê°€ "AN/429744344"ë¡œ ë“¤ì–´ì˜¤ë©´ ê·¸ëŒ€ë¡œ "AN/429744344"ë¡œ ì €ì¥ë¨

### 7.2 `extractSenderId` í•¨ìˆ˜ í™•ì¸ í•„ìš”

**ì˜ˆìƒ ë™ì‘**:
- sender í•„ë“œê°€ "AN/429744344" í˜•ì‹ì¼ ë•Œ
- `extractSenderId()`ëŠ” "429744344"ë¥¼ ë°˜í™˜í•´ì•¼ í•¨
- í•˜ì§€ë§Œ `createCacheKey()`ëŠ” ì›ë³¸ senderIdë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©

**ë¬¸ì œì **:
- `!ì§ˆë¬¸` ëª…ë ¹ì–´ ì²˜ë¦¬ ì‹œ `questionSenderId = extractSenderId(json, sender)` í˜¸ì¶œ
- í•˜ì§€ë§Œ `setPendingQuestion(room, questionSenderId, ...)` í˜¸ì¶œ ì‹œ
- `questionSenderId`ê°€ ì´ë¯¸ ì¶”ì¶œëœ IDë¼ë©´ ë¬¸ì œ ì—†ì–´ì•¼ í•¨
- í•˜ì§€ë§Œ ë¡œê·¸ìƒ ìºì‹œì—ëŠ” "ì˜ìš´ëª¨|AN"ì´ ì €ì¥ë˜ì–´ ìˆìŒ

**ì¶”ì • ì›ì¸**:
- `!ì§ˆë¬¸` ëª…ë ¹ì–´ ì²˜ë¦¬ ì‹œ `extractSenderId()`ê°€ "AN"ì„ ë°˜í™˜
- ë˜ëŠ” `extractSenderId()` ëŒ€ì‹  ë‹¤ë¥¸ ë¡œì§ì´ ì‚¬ìš©ë¨
- ë˜ëŠ” sender í•„ë“œ ìì²´ê°€ "AN"ìœ¼ë¡œ ì „ë‹¬ë¨

### 7.3 í•´ê²° ë°©ì•ˆ

**âœ… ì ìš© ì™„ë£Œ: `createCacheKey`ì—ì„œ senderId ì •ê·œí™”**

`server/db/utils/roomKeyNormalizer.js`ì— `normalizeSenderIdForCache()` í•¨ìˆ˜ ì¶”ê°€:

```javascript
function normalizeSenderIdForCache(senderId) {
    if (!senderId) return '';
    const str = String(senderId).trim();
    
    // 1. ìˆ«ìë§Œ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
    if (/^\d+$/.test(str)) {
        return str;
    }
    
    // 2. "ì´ë¦„/ID" í˜•ì‹ì—ì„œ ë§ˆì§€ë§‰ ë¶€ë¶„ì´ ìˆ«ìë©´ ID ì¶”ì¶œ
    if (str.includes('/')) {
        const parts = str.split('/');
        const lastPart = parts[parts.length - 1].trim();
        if (/^\d+$/.test(lastPart)) {
            return lastPart;  // ìˆ«ì ID ì¶”ì¶œ
        }
        // ìˆ«ìê°€ ì•„ë‹ˆë©´ ì›ë³¸ ìœ ì§€ (í•˜ìœ„ í˜¸í™˜ì„±)
        return str;
    }
    
    return str;
}

function createCacheKey(roomName, senderId) {
    const normalizedRoom = normalizeRoomNameForCache(roomName);
    const normalizedSender = normalizeSenderIdForCache(senderId);  // âœ… ì •ê·œí™” ì ìš©
    return `${normalizedRoom}|${normalizedSender}`;
}
```

**íš¨ê³¼**:
- `"AN"` â†’ `"AN"` (ê·¸ëŒ€ë¡œ ìœ ì§€, í•˜ìœ„ í˜¸í™˜ì„±)
- `"429744344"` â†’ `"429744344"` (ê·¸ëŒ€ë¡œ ìœ ì§€)
- `"ë©ì¥/AN/ì„œìš¸/429744344"` â†’ `"429744344"` (ìˆ«ì ID ì¶”ì¶œ)
- ì´ì œ ìˆ«ì IDê°€ ìˆìœ¼ë©´ í•­ìƒ ìˆ«ì IDë¥¼ ìºì‹œ í‚¤ë¡œ ì‚¬ìš©

**Option 2: `extractSenderId` ì‚¬ìš© ë³´ì¥**

```javascript
// !ì§ˆë¬¸ ëª…ë ¹ì–´ ì²˜ë¦¬ ì‹œ
const questionSenderId = extractSenderId(json, sender);
// í™•ì‹¤íˆ IDë§Œ ì¶”ì¶œëœ ê°’ì¸ì§€ í™•ì¸
if (!questionSenderId || questionSenderId.includes('/')) {
    // ë‹¤ì‹œ ì¶”ì¶œ ì‹œë„
    questionSenderId = extractSenderId(json, sender);
}
setPendingQuestion(room, questionSenderId, title, content);
```

---

## 8. ë‹¤ìŒ ë‹¨ê³„

1. **ì¦‰ì‹œ í™•ì¸**: `extractSenderId` í•¨ìˆ˜ ì½”ë“œ í™•ì¸
2. **ì¦‰ì‹œ í™•ì¸**: `!ì§ˆë¬¸` ëª…ë ¹ì–´ ì²˜ë¦¬ ì‹œ `questionSenderId` ê°’ í™•ì¸ (ë¡œê¹… ì¶”ê°€)
3. **ìˆ˜ì •**: `createCacheKey`ì— senderId ì •ê·œí™” ë¡œì§ ì¶”ê°€
4. **í…ŒìŠ¤íŠ¸**: `!ì§ˆë¬¸` â†’ ì´ë¯¸ì§€ ì „ì†¡ â†’ Naver Cafe ì—…ë¡œë“œ ì „ì²´ íë¦„ í…ŒìŠ¤íŠ¸

