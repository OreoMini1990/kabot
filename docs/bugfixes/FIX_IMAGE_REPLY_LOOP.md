# 이미지 답장 무한루프 문제 해결

## 문제 요약

**증상**: 사용자가 이미지를 보내면 봇이 이미지 답장을 보내고, 그 답장이 다시 이미지로 인식되어 무한루프 발생

**원인**: 
- 질문 대기 상태가 없어도 항상 이미지 답장을 보냄 (`server.js` 라인 2587-2592)
- 이미지 답장이 다시 이미지 메시지로 처리될 수 있음

---

## 해결 방법

### 변경 내용

**파일**: `server/server.js` (라인 2581-2595)

**변경 전**:
```javascript
} else {
  console.log(`[이미지 + 질문] ⚠️ 질문 대기 상태 없음: roomName="${roomName}", senderId="${senderId}"`);
  
  // 캐시에도 저장 (나중에 !질문 명령어에서 사용)
  setPendingAttachment(roomName, senderId, imageResult.url);
  
  // 답장으로 이미지 URL 전송
  ws.pendingImageReply = {
    type: 'image',
    text: `📷 이미지가 서버에 저장되었습니다.\n\nURL: ${imageResult.url}`,
    imageUrl: imageResult.url
  };
  
  console.log(`[이미지 저장] ✅ 답장 준비 완료: ${imageResult.url}`);
}
```

**변경 후**:
```javascript
} else {
  console.log(`[이미지 + 질문] ⚠️ 질문 대기 상태 없음: roomName="${roomName}", senderId="${senderId}"`);
  
  // 캐시에만 저장 (나중에 !질문 명령어에서 사용)
  // ⚠️ 중요: 질문 대기 상태가 없으면 답장을 보내지 않음 (무한루프 방지)
  setPendingAttachment(roomName, senderId, imageResult.url);
  console.log(`[이미지 저장] ✅ 이미지 캐시에 저장 완료 (답장 없음): ${imageResult.url.substring(0, 50)}...`);
  console.log(`[이미지 저장] 💡 !질문 명령어를 사용하시면 자동으로 이미지가 첨부됩니다.`);
  
  // 답장을 보내지 않음 (무한루프 방지)
  // ws.pendingImageReply는 설정하지 않음
}
```

---

## 동작 방식

### Before (수정 전)
1. 사용자가 이미지 전송
2. 질문 대기 상태 확인 → 없음
3. 이미지 캐시 저장
4. **이미지 답장 전송** ← 무한루프의 원인
5. 답장이 다시 이미지로 인식되어 무한 반복

### After (수정 후)
1. 사용자가 이미지 전송
2. 질문 대기 상태 확인 → 없음
3. 이미지 캐시 저장
4. **답장 없음** ✅
5. 사용자가 `!질문` 명령어 실행
6. 캐시에서 이미지 찾아서 질문에 첨부
7. 질문 등록 완료 응답만 전송

---

## 추가 개선 사항 (선택)

### Option 1: 자신이 보낸 메시지 필터링 (추가 안전장치)

이미지 답장이 다시 처리되지 않도록 `isMine` 필드를 확인:

```javascript
// server.js에서 이미지 메시지 처리 시
if (json.isMine === true) {
  console.log(`[이미지 저장] ⚠️ 자신이 보낸 메시지는 무시: message_id=${messageData.message_id}`);
  return; // 처리하지 않음
}
```

하지만 클라이언트에서 이미 `isMine=true`인 메시지는 필터링하고 있을 가능성이 높으므로, 이번 수정만으로도 충분할 것으로 예상됩니다.

---

## 테스트 방법

1. **정상 케이스**: 질문 대기 상태 있을 때
   - `!질문` 명령어 실행
   - 이미지 전송
   - 예상: 질문 등록 완료 응답만 전송 ✅

2. **무한루프 방지**: 질문 대기 상태 없을 때
   - 이미지 전송
   - 예상: 답장 없음 ✅
   - `!질문` 명령어 실행
   - 예상: 캐시된 이미지 자동 첨부 ✅

---

## 예상 결과

### Before (수정 전)
```
사용자: [이미지 전송]
봇: 📷 이미지가 서버에 저장되었습니다. [이미지 포함] ← 무한루프 시작
봇: 📷 이미지가 서버에 저장되었습니다. [이미지 포함]
봇: 📷 이미지가 서버에 저장되었습니다. [이미지 포함]
...
```

### After (수정 후)
```
사용자: [이미지 전송]
봇: (답장 없음) ✅

사용자: !질문 제목 내용
봇: 📝 질문이 등록되었습니다. 혹시 같이 첨부할 이미지가 있나요?

사용자: [이미지 전송]
봇: ✅ 질문 작성 완료! [이미지 포함] ✅
```

---

## 관련 이슈

1. **캐시 키 불일치 문제** (이전에 수정함)
   - `!질문` 명령어에서 senderId 추출 로직 개선
   - `normalizeSenderIdForCache` 함수 강화

2. **이번 수정으로 해결되는 문제**
   - 이미지 답장 무한루프
   - 불필요한 이미지 답장 메시지



